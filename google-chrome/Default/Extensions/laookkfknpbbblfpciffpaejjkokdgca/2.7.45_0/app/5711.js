"use strict";(globalThis.webpackChunkmomentum=globalThis.webpackChunkmomentum||[]).push([[5711],{85711:(e,t,o)=>{o.r(t),o.d(t,{default:()=>g});var a=o(99437),c=o(31624);const i=new(o(97835).Z)("tab.focus.emptySave",.01),s=new(a.Z.extend({name:"FocusDataService",mixins:[c.X],unreactive:()=>({type:"focus",mode:localStorage.getItem("token")?"sync":"cache"}),defaultPath:"focus",methods:{add(e,t){return t.focus?c.X.methods.add.apply(this,arguments):(i.info("Focus data service add with no focus",{userUuid:localStorage.getItem("userId"),stackTrace:m.utils.getStackTrace()}),Promise.reject())}}}));var d=o(2770);const n=a.Z.extend({name:"FocusModel",mixins:[d.Z],data:()=>({id:null,archived:!1,completed:!1,createdDate:m.now(),focus:null,forDate:null,todoId:null,props:["focus","completed","archived","forDate","createdDate","todoId"]}),methods:{updateData(e){d.Z.methods.updateData.call(this,e),this.completed=!!e.completed}}});var u=o(94234),l=o(20144),h=o(40531);const r=new(l.ZP.extend({name:"AutoFocusManager",data:()=>({activeFocus:null}),computed:{autoFocusEnabled:()=>h.ax.autoFocus&&m.conditionalFeatures.featureEnabled("pinfocus")},watch:{autoFocusEnabled:{handler(e){e?this.getTopTodo().then((e=>this.activeFocus=this.createFocusFromTodo(e))):this.activeFocus=null},immediate:!0},"activeFocus.focus"(e){this.activeFocus&&m.trigger("todo:set:title",this.activeFocus.todoId,e)},"activeFocus.completed"(e){this.activeFocus&&m.trigger("todo:set:done",this.activeFocus.todoId,e)}},created(){m.on("todo:globalChange",this.onTodoChange)},destroyed(){m.off("todo:globalChange",this.onTodoChange)},methods:{getTopTodo:()=>m.widgetManager.getWidgetAsync("todo").then((e=>e.getTopTodo())),onTodoChange(...e){var t,o,a;const c=e[0];if(e.find((e=>e&&(e.ignoreRender||e.silent)))||!this.autoFocusEnabled||null==c||!c.changed||!Object.keys(c.changed).length||!1===(null===(t=c.changed)||void 0===t?void 0:t.isLoading))return;const i=(null===(o=c.changed)||void 0===o?void 0:o.completedDate)||(null===(a=c.changed)||void 0===a?void 0:a.modifiedServer);this.getTopTodo().then((e=>{var t,o;e?this.activeFocus=this.createFocusFromTodo(e):null!==(t=this.activeFocus)&&void 0!==t&&t.todoId&&(c.get("id")||c.id).includes(null===(o=this.activeFocus)||void 0===o?void 0:o.todoId)&&(this.activeFocus.completed=c.get("done"),i||(this.activeFocus=null))}))},createFocusFromTodo(e){if(!e)return null;let t=new n;return t.updateData({focus:e.get("title"),archived:!1,completed:e.get("done"),createdDate:m.now(),id:m.utils.uuidv4(),todoId:e.get("id")||e.id,forDate:m.utils.getDateString()}),t}}}));var v=o(81405);const g=new(a.Z.extend({name:"FocusCollection",mixins:[u.FZ,u.mX],unreactive:()=>({type:"focus",Model:n,dataService:s,newModel:null,analytics:new v.ZP({feature:"focus"})}),computed:{emptyFocus(){return!this.activeFocus.focus},activeFocusInCollection(){const e=m.utils.getDateString(),t=Object.values(this.data.items).filter((t=>!t.archived&&t.forDate===e)).sort(((e,t)=>t.createdDate-e.createdDate));return t.length?t[0]:null},activeFocus(){return r.activeFocus||this.activeFocusInCollection||this.newModel},loaded(){return this.data.loaded}},created(){this.instantiateNewModel(),m.on("focus:pin",this.onFocusPin),m.on("todo:globalChange",this.onTodoChange),m.on("newDay",this.archiveAll)},destroyed(){m.off("focus:pin",this.onFocusPin),m.off("todo:globalChange",this.onTodoChange),m.off("newDay",this.archiveAll)},methods:{instantiateNewModel(){this.newModel=new this.Model,this.newModel.copyProperties()},async save(){const e=this.emptyFocus;r.activeFocus||this.activeFocus.editProps.focus&&await this[this.emptyFocus?"add":"update"](this.activeFocus),e&&this.instantiateNewModel(),this.analytics.capture("focus "+(e?"add":"edit"),{position:localStorage.getItem("pomodoro-showing")?"pomodoro":"default"}),this.activeFocus.commitChanges(),this.activeFocus.todoId&&m.trigger("todo:set:title",this.activeFocus.todoId,this.activeFocus.focus)},archive(){this.analytics.capture("focus clear",{completed:this.activeFocus.completed}),r.activeFocus?h.ax.autoFocus=!1:u.FZ.methods.archive.call(this,this.activeFocus)},archiveAll(){Object.values(this.data.items).forEach((e=>this.archive(e)))},toggleComplete(){const e=this.activeFocus.completed;this.analytics.capture("focus "+(e?"uncomplete":"complete"),Object.assign({position:localStorage.getItem("pomodoro-showing")?"pomodoro":"default"},e?{}:{autofocus:r.autoFocusEnabled})),this.activeFocus.completed=!e,r.activeFocus||this.dataService.update(this.activeFocus.id,{completed:!e}).then((()=>{this.activeFocus.todoId&&m.trigger("todo:set:done",this.activeFocus.todoId,!e)})).catch((t=>{throw this.activeFocus.completed=e,t}))},onFocusPin(e){h.ax.autoFocus=!1;let t=r.createFocusFromTodo(e);t&&t.focus&&(t.copyProperties(),this.add(t))},onTodoChange(...e){var t,o;const a=e[0];if(e.find((e=>e&&(e.ignoreRender||e.silent)))||!this.activeFocus||!Object.keys(this.data.items).length||null==a||!a.changed)return;let c=Object.values(this.data.items).find((e=>{var t;return e.todoId&&e.todoId===((null===(t=a.get)||void 0===t?void 0:t.call(a,"id"))||(null==a?void 0:a.id))}));if(!c)return;if(null!==(t=e[0])&&void 0!==t&&null!==(o=t.changed)&&void 0!==o&&o.deleted)return void this.archive();const i=a.get("done"),s=a.get("title");c.completed===i&&c.focus===s||(c.completed=i,c.focus=s,this.dataService.update(c.id,{completed:i,focus:s}))}}}))}}]);